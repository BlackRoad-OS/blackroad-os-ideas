name: Idea Sync

on:
  push:
    branches: ["main", "work", "scaffold/ideas-gen-0"]
    paths:
      - "ideas/*.md"
      - ".github/workflows/sync.yml"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync idea issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const ideasDir = path.join(process.cwd(), 'ideas');
            const files = fs.readdirSync(ideasDir).filter((file) => file.endsWith('.md'));

            function parseFrontmatter(content) {
              const match = content.match(/^---\n([\s\S]*?)\n---/);
              if (!match) return { data: {}, body: content };
              const data = {};
              for (const line of match[1].split('\n')) {
                const [key, ...rest] = line.split(':');
                if (!key) continue;
                const raw = rest.join(':').trim();
                if (raw.startsWith('[') && raw.endsWith(']')) {
                  data[key.trim()] = raw
                    .slice(1, -1)
                    .split(',')
                    .map((item) => item.trim())
                    .filter(Boolean);
                } else {
                  data[key.trim()] = raw;
                }
              }
              const body = content.slice(match[0].length).trim();
              return { data, body };
            }

            for (const file of files) {
              const content = fs.readFileSync(path.join(ideasDir, file), 'utf8');
              const parsed = parseFrontmatter(content);
              const title = `Idea: ${parsed.data.title || file}`;
              const body = [
                `**Status:** ${parsed.data.status || 'draft'}`,
                `**ETA:** ${parsed.data.eta || 'TBD'}`,
                parsed.body,
              ].join('\n\n');

              const search = await github.rest.search.issuesAndPullRequests({
                q: `${title} repo:${context.repo.owner}/${context.repo.repo} in:title state:open`,
              });

              if (search.data.items.length > 0) {
                const issue = search.data.items[0];
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  title,
                  body,
                  labels: Array.from(new Set([...(parsed.data.tags || []), 'idea'])),
                });
                core.info(`Updated issue #${issue.number} for ${file}`);
              } else {
                const created = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title,
                  body,
                  labels: Array.from(new Set([...(parsed.data.tags || []), 'idea'])),
                });
                core.info(`Created issue #${created.data.number} for ${file}`);
              }
            }
