name: ü§ñ BlackRoad Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["üîç BlackRoad Compliance Check"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-Merge Compliant PRs
    runs-on: ubuntu-latest

    # Only run for bot-created PRs
    if: |
      github.event.pull_request.user.login == 'github-actions[bot]' ||
      github.actor == 'github-actions[bot]'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Get PR Details
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR number
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            # If triggered by workflow_run, find the PR
            PR_NUMBER=$(gh pr list --head blackroad-auto-fix --json number --jq '.[0].number')
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found, exiting..."
            exit 0
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Get PR status
          PR_DATA=$(gh pr view "$PR_NUMBER" --json statusCheckRollup,headRefName,mergeable,mergeStateStatus)

          # Extract status
          STATUS=$(echo "$PR_DATA" | jq -r '.statusCheckRollup[] | select(.conclusion != null) | .conclusion' | sort -u)
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_DATA" | jq -r '.mergeStateStatus')
          BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT
          echo "merge_state=$MERGE_STATE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          echo "PR #$PR_NUMBER status: $STATUS, mergeable: $MERGEABLE, state: $MERGE_STATE"

      - name: ‚úÖ Validate PR for Auto-Merge
        id: validate
        run: |
          CAN_MERGE="false"

          # Check 1: Is this from blackroad-auto-fix branch?
          if [[ "${{ steps.pr.outputs.branch }}" == "blackroad-auto-fix" ]]; then
            echo "‚úÖ PR is from auto-fix branch"

            # Check 2: Is mergeable?
            if [[ "${{ steps.pr.outputs.mergeable }}" == "MERGEABLE" ]]; then
              echo "‚úÖ PR is mergeable (no conflicts)"

              # Check 3: All checks passed or no checks?
              if [[ -z "${{ steps.pr.outputs.status }}" ]] || [[ "${{ steps.pr.outputs.status }}" == "SUCCESS" ]]; then
                echo "‚úÖ All checks passed (or no checks required)"
                CAN_MERGE="true"
              else
                echo "‚ö†Ô∏è  Some checks failed or are pending: ${{ steps.pr.outputs.status }}"
              fi
            else
              echo "‚ö†Ô∏è  PR has merge conflicts or is not mergeable"
            fi
          else
            echo "‚ÑπÔ∏è  Not an auto-fix PR (branch: ${{ steps.pr.outputs.branch }}), skipping"
          fi

          echo "can_merge=$CAN_MERGE" >> $GITHUB_OUTPUT

      - name: üöÄ Merge PR
        if: steps.validate.outputs.can_merge == 'true' && steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          echo "ü§ñ Merging PR #$PR_NUMBER..."

          # Merge with squash and delete branch
          MERGE_BODY=$'‚úÖ Auto-merged by BlackRoad Auto-Merge System\n\nThis PR passed all compliance checks and was automatically merged.\n\nü§ñ Automated by BlackRoad Auto-Merge\n¬© 2025-2026 BlackRoad OS, Inc.'
          gh pr merge "$PR_NUMBER" \
            --squash \
            --delete-branch \
            --body "$MERGE_BODY"

          echo "‚úÖ PR #$PR_NUMBER merged successfully!"

      - name: üí¨ Add Success Comment
        if: steps.validate.outputs.can_merge == 'true' && steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          COMMENT_BODY=$'ü§ñ **Auto-Merge Successful**\n\nThis PR has been automatically merged because:\n- ‚úÖ Created by BlackRoad auto-fix bot\n- ‚úÖ All compliance checks passed\n- ‚úÖ No merge conflicts\n- ‚úÖ No manual review required\n\nThe changes are now live on the default branch.\n\n---\nü§ñ Automated by BlackRoad Auto-Merge System\n¬© 2025-2026 BlackRoad OS, Inc.'
          gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY" || true

      - name: üìù Create Issue on Validation Failure
        if: |
          steps.validate.outputs.can_merge == 'false' &&
          steps.pr.outputs.number != '' &&
          steps.pr.outputs.branch == 'blackroad-auto-fix'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          REPO="${{ github.repository }}"

          gh issue create \
            --title "‚ö†Ô∏è  Auto-Fix PR Requires Manual Review: #$PR_NUMBER" \
            --body "$(printf '## Auto-Fix PR Could Not Be Auto-Merged\n\n**PR:** #%s\n**Status:** Manual review needed ‚ö†Ô∏è\n**Reason:** Checks failed or merge conflicts detected\n\n### Details:\nThe auto-fix PR did not pass automatic validation.\n\n**Branch:** `%s`\n**Mergeable:** `%s`\n**Merge State:** `%s`\n**Check Status:** `%s`\n\n### Action Required:\nPlease review the PR manually and resolve any issues.\n\n**PR Link:** https://github.com/%s/pull/%s\n\n---\nü§ñ Automated Alert from BlackRoad Auto-Merge System\n¬© 2025-2026 BlackRoad OS, Inc.' \
              "$PR_NUMBER" \
              "${{ steps.pr.outputs.branch }}" \
              "${{ steps.pr.outputs.mergeable }}" \
              "${{ steps.pr.outputs.merge_state }}" \
              "${{ steps.pr.outputs.status }}" \
              "$REPO" \
              "$PR_NUMBER")" \
            --label "auto-fix-failed,needs-review" || true

      - name: üö® Notify on Critical Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üö® Auto-merge workflow encountered an error"
          echo "This may require manual intervention"
          # If Slack webhook is configured, uncomment below:
          # curl -X POST "${{ secrets.SLACK_WEBHOOK }}" -H 'Content-Type: application/json' \
          #   -d '{"text":"üö® Auto-merge failed in ${{ github.repository }}"}'
