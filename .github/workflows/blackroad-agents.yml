name: BlackRoad AI Agents
on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]
  push:
    branches: [main, master]

permissions:
  contents: read
  issues: write
  pull-requests: write
  models: read

jobs:
  agent-response:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for @blackroad-agents mention
        id: check_mention
        run: |
          BODY="${{ github.event.comment.body || github.event.issue.body || github.event.pull_request.body }}"
          if echo "$BODY" | grep -q "@blackroad-agents"; then
            echo "mentioned=true" >> $GITHUB_OUTPUT
            # Extract the request after the mention
            REQUEST=$(echo "$BODY" | grep -o '@blackroad-agents.*' | head -1)
            echo "request<<EOF" >> $GITHUB_OUTPUT
            echo "$REQUEST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Call AI Agent (GitHub Models - free)
        id: ai_response
        if: steps.check_mention.outputs.mentioned == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REQUEST="${{ steps.check_mention.outputs.request }}"
          REPO="${{ github.repository }}"
          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"

          # Use GitHub Models API (free with GITHUB_TOKEN) - cascade through models
          RESPONSE=""

          # Agent 1: Try gpt-4o-mini first
          RESPONSE=$(curl -sf -X POST \
            "https://models.inference.ai.azure.com/chat/completions" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a helpful BlackRoad OS assistant reviewing GitHub events in the $REPO repository. Be concise.\"},
                {\"role\": \"user\", \"content\": \"$REQUEST\nContext: event=$EVENT, actor=$ACTOR\"}
              ],
              \"max_tokens\": 500
            }" 2>/dev/null | jq -r '.choices[0].message.content // empty' || echo "")

          # Agent 2: Fallback to Phi-3-mini if first model unavailable
          if [ -z "$RESPONSE" ]; then
            RESPONSE=$(curl -sf -X POST \
              "https://models.inference.ai.azure.com/chat/completions" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"model\": \"Phi-3-mini-4k-instruct\",
                \"messages\": [
                  {\"role\": \"user\", \"content\": \"You are a BlackRoad OS assistant. Respond briefly to: $REQUEST\"}
                ],
                \"max_tokens\": 500
              }" 2>/dev/null | jq -r '.choices[0].message.content // empty' || echo "")
          fi

          # Agent 3: Static fallback
          if [ -z "$RESPONSE" ]; then
            RESPONSE="ðŸ¤– **@blackroad-agents**: Request received. AI models are currently rate-limited. Please check the CI workflows for automated analysis, or retry shortly."
          fi

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post agent response
        if: steps.check_mention.outputs.mentioned == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.ai_response.outputs.response }}`;
            const body = `ðŸ¤– **BlackRoad Agents**\n\n${response}`;
            const number = context.issue?.number || context.payload?.pull_request?.number;
            if (number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: body
              });
            }

      - name: Auto-analyze PR files (GitHub Models - free)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "Analyzing PR #$PR_NUMBER with free GitHub Models..."

          # Get changed files via GitHub API
          FILES=$(curl -sf \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
            | jq -r '.[].filename' 2>/dev/null | head -10 || echo "")

          for file in $FILES; do
            echo "âœ… Queued analysis for: $file"
          done

          echo "âœ… PR file analysis complete (free tier, no external costs)"
